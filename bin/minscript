#!/usr/bin/env coffee

vm      = require 'vm'
fs      = require 'fs'
util    = require 'util'
readline = require 'readline'

parser  = require '../lib/parser'
emitter = require '../lib/emitter'
wrapper = require '../lib/wrapper'

replEmitter = emitter.init()
ctx = vm.createContext()
ctx['console'] = console;

compile = (source)->
  #

repl = ->
  rl = readline.createInterface
    input: process.stdin
    output: process.stdout

  rl.setPrompt('Minscript > ')
  rl.prompt()

  rl.on 'line', (line)->
    ast = parser.parse(line)
    console.log ast
    js = replEmitter.emit(ast).join(";")
    console.log js
    console.log "=>", vm.runInContext(js, ctx)
    rl.prompt()

switch process.argv[2]
  when 'repl'
    repl()
  when 'compile'
    compile(argv[3])
  else
    repl()
